<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sensores Individuais</title>

  <link rel="stylesheet" href="./../css/style.css" />
  <link rel="icon" href="../assets/icon/logo.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<aside>
  <a href="../index.html"><img src="../assets/imgs/SMFlogoFull.png" alt=""></a>
  <h2>Seja bem vindo, Brandão!</h2>
  <li>
    <ul><a class="aside_buttons" href="./dashboard.html">
        <p>Graficos Gerais</p>
      </a></ul>
    <ul style="background-color: #045064; color: #08a4bd;"><a class="aside_buttons" href="./sensorIndividual.html">
        <p>Sensores Individuais</p>
      </a></ul>
    <ul><a class="aside_buttons" href="./heatMapSMF.html">
        <p>Mapa de calor dos setores</p>
      </a></ul>
    <ul><a class="aside_buttons" href="./gerenciar.html">
        <p>Gerencie sua Conta</p>
      </a></ul>
    <ul><a class="aside_buttons" href="../">
        <p>Voltar para Tela inicial</p>
      </a></ul>
    <ul class="bt_vermelho"><a class="aside_buttons" href="../LoginCadastro/login.html">
        <p>Sair da conta</p>
      </a></ul>
  </li>
</aside>


<body class="dash_body">
  <main>
    <h2 id="titulo_dash">Sensores Individuais</h2>

    <!-- SETORES QUE O USUÁRIO CLICA -->
    <div id="setores" class="setores">

      <div value="acougue" onclick="buscar(1)" class="layout"> <img
          src="https://atribunanews.com.br/wp-content/uploads/2023/02/proton-tl-carne.jpg" alt="">
        <h3>Açougue</h3>
      </div>

      <div value="padaria" onclick="buscar(17)" class="layout"> <img
          src="https://invexo.com.br/blog/wp-content/uploads/2022/10/paes-padarias-copacabana-rio-de-janeiro.jpg"
          alt="">
        <h3>Padaria</h3>
      </div>

      <div value="limpeza" onclick="buscar(13)" class="layout"> <img
          src="https://images.ctfassets.net/qfxflpv0atz9/CzEYLNqLg4zfuBpkDBV90/66f4d8b752e76356240b86bf3b1b39df/thumb-Lista-de-produtos-de-limpeza-que-nao-podem-faltar-na-sua-casa.jpg?fm=webp&q=90"
          alt="">
        <h3>Limpeza</h3>
      </div>

      <div value="bebidas" onclick="buscar(10)" class="layout"> <img
          src="https://s2-valor.glbimg.com/Dg7uwMmR2vz8RHNmfkuqBehj-b8=/984x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_63b422c2caee4269b8b34177e8876b93/internal_photos/bs/2021/F/s/lFAPvYROSlp8vIBjhycw/foto02emp-301-refri-b5.jpg"
          alt="">
        <h3>Bebidas</h3>
      </div>

      <div value="frios" onclick="buscar(16)" class="layout"> <img
          src="https://trzfood.com.br/wp-content/uploads/2022/08/trz-food-02.jpg" alt="">
        <h3>Frios e Laticinios</h3>
      </div>

      <div value="higiene" onclick="buscar(15)" class="layout"> <img
          src="https://www.enfoquems.com.br/wp-content/uploads/media/images/944/58288//5cc1909f5f511ca797f3536de1bf1f802e7c3ae4150ce.jpg"
          alt="">
        <h3>Higiene Pessoal</h3>
      </div>

      <div value="congelados" onclick="buscar(18)" class="layout"> <img
          src="https://elementusconsultoria.com/wp-content/uploads/2023/11/frozen-food-aisle.jpg" alt="">
        <h3>Congelados</h3>
      </div>

      <div value="frutas" onclick="buscar(14)" class="layout"> <img
          src="https://s2.glbimg.com/HwE5c_U6IdAoUi-9Xgpytj8lxFk=/e.glbimg.com/og/ed/f/original/2020/12/22/800px-fruit_stand_246046301.jpeg"
          alt="">
        <h3>Hortifruti</h3>
      </div>

      <div value="mercearia" onclick="buscar(12)" class="layout"> <img
          src="https://sennda.com.br/wp-content/uploads/2021/03/pexels-mehrad-vosoughi-3687999-scaled.jpg" alt="">
        <h3>Mercearia</h3>
      </div>

    </div>

    <div id="setorEsp" style="display: none;" class="setores">
      <canvas id="grafico"></canvas>
    </div>
  </main>

  <script>
    const ctx = document.getElementById("grafico");
    let labels_horas = [];
    let valores_leitura = [];

    function buscarDadosSensor() {
      fetch(`/medidas/setor/${idSensorFunc}`)
        .then(function (resposta) {
          if (!resposta.ok) {
            throw "Erro ao buscar os dados de cada sensor";
            // return resposta.json();
          }
          console.log(resposta);
          // respostaJson = resposta.json();
          // console.log(respostaJson);
          return resposta.json();
        })
        .then(function (dados) {
          console.log("O que veio do banco:", dados[0]);

          for (let i = 0; i < dados.length; i++) {
            const registro = dados[i];


            labels_horas.push(registro.hora);
            valores_leitura.push(Number(registro.leitura));
          }

          plotarGraficoSensorIndividual()

        })
        .catch(function (erro) {
          console.error(erro);
        });
    }

    let grafico;
    var idSensorFunc = 1;

    function buscar(a) {
      idSensorFunc = a;
      setorEsp.style.display = 'block';
      buscarDadosSensor()
    }

    function plotarGraficoSensorIndividual() {
      if (grafico) grafico.destroy();

      grafico = new Chart(ctx, {
        type: "line",
        data: {
          labels: [], // -----------------------------------------------------
          datasets: [{
            label: "Fluxo (Manhã)",
            data: [],
            borderColor: "#08a4bd",
            backgroundColor: "rgba(8, 164, 189, 0.3)",
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          scales: {
            y: {
              suggestedMin: 0
            }
          }
        }
      });
      console.log(labels_horas)
      console.log(valores_leitura)
      grafico.data.labels = labels_horas;
      grafico.data.datasets[0].data = valores_leitura;
      grafico.update();

     setTimeout(() => {
      atualizarGrafico(idSensorFunc)
     }, 2000); 
    }

    function atualizarGrafico(idSensorFunc) {

      fetch(`/medidas/tempo-real/${idSensorFunc}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            obterdados(idSensorFunc);
            // alertar(novoRegistro, idAquario);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            let avisoCaptura = document.getElementById(`avisoCaptura${idSensorFunc}`)
            avisoCaptura.innerHTML = ""


            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
              console.log("---------------------------------------------------------------")
              console.log("Como não há dados novos para captura, o gráfico não atualizará.")
              avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
              console.log("Horário do novo dado capturado:")
              console.log(novoRegistro[0].momento_grafico)
              console.log("Horário do último dado capturado:")
              console.log(dados.labels[dados.labels.length - 1])
              console.log("---------------------------------------------------------------")
            } else {
              // tirando e colocando valores no gráfico
              dados.labels.shift(); // apagar o primeiro
              dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

              dados.datasets[0].data.shift();  // apagar o primeiro de umidade
              dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

              dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
              dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

              myChart.update();
            }
            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensorFunc), 2000);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensorFunc), 2000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }

  </script>

</body>

</html>